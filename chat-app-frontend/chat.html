<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{--accent:#2563eb}
    body{font-family:Inter,Arial;margin:0;height:100vh;display:flex;flex-direction:column}
    header{background:var(--accent);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
    main{display:flex;flex:1;overflow:hidden}
    #left{width:260px;border-right:1px solid #e6e6e6;padding:12px;box-sizing:border-box;overflow:auto}
    #main{flex:1;display:flex;flex-direction:column}
    #chatArea{flex:1;padding:12px;overflow:auto;background:#fafafa}
    #composer{display:flex;padding:10px;border-top:1px solid #eee}
    #composer input{flex:1;padding:10px;margin-right:8px;border:1px solid #ddd;border-radius:6px}
    .msg{margin-bottom:8px}
    .me{font-weight:600}
    .private{background:#fff6e5;padding:6px;border-radius:6px;display:inline-block}
    @media(max-width:700px){#left{display:none}}
  </style>
</head>
<body>
  <header>
    <div>Chat App</div>
    <div><button id="logoutBtn">Logout</button></div>
  </header>
  <main>
    <div id="left">
      <h3>Rooms</h3>
      <div id="roomsList"><button data-room="general" class="roomBtn"># general</button></div>
      <hr/>
      <h3>Direct Message</h3>
      <input id="contactInput" placeholder="username to DM"/>
      <button id="addContactBtn">Set DM</button>
    </div>

    <div id="main">
      <div id="chatArea"></div>
      <div id="composer">
        <input id="message" placeholder="Type a message...">
        <select id="targetType"><option value="room">Room</option><option value="private">Private</option></select>
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </main>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script src="utils.js"></script>
<script>
(function(){
  const token = getToken();
  if(!token){ window.location = '/index.html'; return; }

  let stompClient = null;
  let currentRoom = 'general';
  let currentPrivateTarget = null;

  const chatArea = document.getElementById('chatArea');
  const sendBtn = document.getElementById('sendBtn');
  const messageInput = document.getElementById('message');
  const targetType = document.getElementById('targetType');
  const contactInput = document.getElementById('contactInput');
  const addContactBtn = document.getElementById('addContactBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const roomsList = document.getElementById('roomsList');

  addContactBtn.addEventListener('click', ()=> {
    currentPrivateTarget = contactInput.value.trim() || null;
    alert(currentPrivateTarget ? `Private target set to ${currentPrivateTarget}` : 'Private target cleared');
  });

  logoutBtn.addEventListener('click', ()=> { removeToken(); window.location='/index.html'; });

  roomsList.addEventListener('click', (e)=>{
    if(e.target.classList.contains('roomBtn')){
      currentRoom = e.target.dataset.room;
      appendEvent('Switched to room ' + currentRoom);
      // subscribe to room topic
    }
  });

  function appendEvent(txt){
    const p = document.createElement('div'); 
    p.className='msg'; 
    p.style.color='#666'; 
    p.textContent=txt; 
    chatArea.appendChild(p); 
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  function appendMessage(message, isPrivate=false){
  // Try sender, then user, then user-name, then fallback to 'unknown'
  const who = message.sender || message.user || message['user-name'] || 'unknown';
  const content = message.content || '';
  const p = document.createElement('div'); 
  p.className='msg';
  p.innerHTML = `<strong>${who}</strong>: <span class="${isPrivate?'private':''}">${content}</span>`;
  chatArea.appendChild(p); 
  chatArea.scrollTop = chatArea.scrollHeight;
}

  function connect(){
    const socket = new SockJS('http://localhost:8080/ws');
    stompClient = Stomp.over(socket);
    const headers = { Authorization: 'Bearer ' + token };

    stompClient.connect(headers, function(frame){
      appendEvent('Connected: ' + frame);

      stompClient.subscribe('/topic/messages', function(m){
        const b = JSON.parse(m.body); appendMessage(b);
      });

      stompClient.subscribe('/user/queue/private', function(m){
        const b = JSON.parse(m.body); appendMessage(b, true);
      });

      // subscribe to room topics if needed
      stompClient.subscribe('/topic/room/' + currentRoom, function(m){
        const b = JSON.parse(m.body); appendMessage(b);
      });

    }, function(err){ appendEvent('Connect error: ' + JSON.stringify(err)); });
  }

  function sendMessage(){
    debugger
    const text = messageInput.value.trim();
    if(!text) return;
    const payload = { content: text, timestamp: new Date().toISOString(), room: currentRoom, target: currentPrivateTarget };

    if(targetType.value === 'room'){
      stompClient.send('/app/room', {}, JSON.stringify(payload));
    } else {
      stompClient.send('/app/private', {}, JSON.stringify(payload));
    }
    const p = document.createElement('div'); 
    p.className='msg';
    p.style.textAlign = 'right';
    p.innerHTML = `<strong>you</strong>: <span class="${targetType.value !== 'room'?'private':''}" style="background-color: #BBE2F4; text-align: right">${text}</span>`;
    chatArea.appendChild(p); 
    chatArea.scrollTop = chatArea.scrollHeight;
    messageInput.value = '';
  }

  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keydown', e=> { if(e.key === 'Enter') sendMessage(); });

  connect();
})();
</script>
</body>
</html>
